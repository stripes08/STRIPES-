
const apiBase = '/api';let editingId=null;let currentDispatch=null;async function api(path,opts={}){const res=await fetch(apiBase+path,Object.assign({headers:{'Content-Type':'application/json'}},opts));if(!res.ok){const t=await res.text();throw t;}try{return await res.json();}catch(e){return {};}}
document.addEventListener('DOMContentLoaded',()=>{const form=document.getElementById('orderForm');const tbody=document.querySelector('#ordersTable tbody');const fileInput=document.getElementById('fileInput');load();form.addEventListener('submit',async(e)=>{e.preventDefault();const data=Object.fromEntries(new FormData(form).entries());if(data.qty)data.qty=Number(data.qty);try{if(editingId){await api('/orders/'+editingId,{method:'PUT',body:JSON.stringify(data)});editingId=null;}else{await api('/orders',{method:'POST',body:JSON.stringify(data)});}form.reset();load();}catch(err){alert('Save failed: '+err);}});document.getElementById('clearBtn').addEventListener('click',()=>{form.reset();editingId=null;});document.getElementById('importBtn').addEventListener('click',async()=>{const f=fileInput.files[0];if(!f)return alert('Choose CSV');const fd=new FormData();fd.append('file',f);try{const r=await fetch('/api/import',{method:'POST',body:fd});const j=await r.json();alert('Imported: '+(j.imported||0));load();}catch(e){alert('Import failed: '+e);}});document.getElementById('exportBtn').addEventListener('click',()=>{window.location='/api/export';});document.getElementById('search').addEventListener('input',async(e)=>{const q=e.target.value.trim();const rows=await api('/orders'+(q?('?q='+encodeURIComponent(q)):''));render(rows);});tbody.addEventListener('click',async(e)=>{const tr=e.target.closest('tr');if(!tr)return;const id=tr.dataset.id;if(e.target.matches('.edit-btn')){const o=await api('/orders/'+id);fillForm(o);editingId=id;}else if(e.target.matches('.del-btn')){if(!confirm('Delete?'))return;await api('/orders/'+id,{method:'DELETE'});load();}else if(e.target.matches('.dispatch-btn')){currentDispatch=await api('/orders/'+id);openDispatch(currentDispatch);} });document.getElementById('saveDispatch').addEventListener('click',async()=>{const checks=Array.from(document.querySelectorAll('#dispatch-list input[type=checkbox]'));const total=checks.length;const checked=checks.filter(c=>c.checked).length;let status='Pending';if(checked===total)status='Delivered';else if(checked>0)status='Partial';const delivered=checks.filter(c=>c.checked).map(c=>c.dataset.prod).join('; ');const undelivered=checks.filter(c=>!c.checked).map(c=>c.dataset.prod).join('; ');const body=Object.assign({},currentDispatch,{dispatch_status:status,delivered_items:delivered,undelivered_items:undelivered});await api('/orders/'+currentDispatch.id,{method:'PUT',body:JSON.stringify(body)});closeDispatch();load();});document.getElementById('closeDispatch').addEventListener('click',closeDispatch);function openDispatch(order){const list=document.getElementById('dispatch-list');list.innerHTML='';const parts=(order.product_details||'').split(';').map(s=>s.trim()).filter(Boolean);const deliveredSet=new Set((order.delivered_items||'').split(';').map(s=>s.trim()).filter(Boolean));parts.forEach(p=>{const li=document.createElement('li');const cb=document.createElement('input');cb.type='checkbox';cb.dataset.prod=p;if(deliveredSet.has(p))cb.checked=true;li.appendChild(cb);li.appendChild(document.createTextNode(' '+p));list.appendChild(li);});document.getElementById('dispatch-modal').style.display='flex';}function closeDispatch(){document.getElementById('dispatch-modal').style.display='none';}function fillForm(o){const f=document.getElementById('orderForm');for(const k of ['po_no','po_date','client_name','product_details','qty','dispatch_status','invoice_no','invoice_date','invoice_amount','payment_status','delivered_items','undelivered_items']) if(f[k]) f[k].value=o[k]||'';}async function load(){const rows=await api('/orders');render(rows);}function render(rows){tbody.innerHTML='';rows.forEach((r,i)=>{const tr=document.createElement('tr');tr.dataset.id=r.id;tr.innerHTML=`<td>${i+1}</td><td>${r.po_no||''}</td><td>${r.po_date||''}</td><td>${r.client_name||''}</td><td>${(r.product_details||'').replace(/;/g,'; ')}</td><td>${r.qty||0}</td><td>${r.dispatch_status||''}</td><td>${r.invoice_no||''}</td><td>${r.invoice_amount||''}</td><td>${r.payment_status||''}</td><td>${r.delivered_items||''}</td><td>${r.undelivered_items||''}</td><td><button class="edit-btn">Edit</button><button class="dispatch-btn">Dispatch</button><button class="del-btn">Delete</button></td>`;tbody.appendChild(tr);});} }));
